<!doctype html>
<html>
<head>

<title>
Sergey's Test project
</title>

<!-- meta -->
<meta charset = "utf-8">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no">

<!-- css -->
<link rel = "stylesheet" type = "text/css" href = "style/main.css">
	
<!-- script -->
 <script src = "script\jquery\jquery-3.3.1.min.js"> </script> 
 <script src = "script\js.cookie.js"> </script> 
 <script src = "script\json2.js"> </script>  
 <script type="text/javascript" id="cookieinfo"	src="script\cookieinfo.min.js"> </script>


 

<script>
<!-- global vars -->
//googleAutocompleteAPIKey
var googleJSAPIKey= "AIzaSyAHkxXivUMUY-WKiXtDEFfH9u0-M6VD0ZE";

var autocompleteURL = "https://maps.googleapis.com/maps/api/place/autocomplete/";

var map;

var center;

var defaultHistoryOptionsAmount = 2;

var autocomplete;
//TODO
var place;

var HistoryItemsArray = [];
class HistoryItem  {

	constructor (description, lng, lat, zoom) {
	  this.description = description;
	  this.lng = lng;
	  this.lat = lat;
	  this.zoom = zoom;
	}
}

</script>

</head>

<body>
<container>
<div id = "searchControls">
<input type ="text" class = "col-3" placeholder="I'm searching for " id = "searchAddressField" name= "searchAddressField"/>
<input type = "button" class = "col-3" value = "Go" onclick = "go();"   id = "submitButton" name= "submitButton"/>
<select id = "selectHistory" class = "col-3" name = "selectHistory">
<option value = "">History</option>
</select>

</div>

<div id = "wrapper">
<div id = "map"
</div>
</div>

<div class = "logos">
	<img id="googleLogo" src = "image\google\agreement\powered_by_google_on_white_hdpi.png" alt="Powered by Google logo"/>
	<img id= "ConcisoLogo" src = "image\conciso\logo.png" alt="Supported by Conciso"/>
</div>
</container>
	   <script>
	   
	   function go (){
	   
			console.log("0_o");			
			
			let selectHistory = document.getElementById("selectHistory");
			let newOption = document.createElement("option");
			let currentSearchAddressField = document.getElementById("searchAddressField").value;
			for (var i = 0; i <HistoryItemsArray.length; i++)
				if (HistoryItemsArray[i].description == currentSearchAddressField)
					{
					console.log(">>>error: duplicate address");
					return;
				}
			newOption.text = currentSearchAddressField ;
			selectHistory.add(newOption, selectHistory[1]);
			
			if(selectHistory.length > defaultHistoryOptionsAmount)
				selectHistory.remove(defaultHistoryOptionsAmount + 1); // +    - default "History"
			
			map.panTo(center);
			map.setZoom(11);
			
			let location = place.geometry.location;
			
			lat = autocomplete.getPlace().geometry.location.lat();
			lng = autocomplete.getPlace().geometry.location.lng();

			let zoom = map.getZoom();
			let newHistoryItem = new HistoryItem(currentSearchAddressField, lng, lat, zoom);
			HistoryItemsArray.push(newHistoryItem);
			while(HistoryItemsArray.length>defaultHistoryOptionsAmount)
				HistoryItemsArray.shift();
			//console.log("***" + JSON.stringify(HistoryItemsArray, null, 2));
			
			//save data
			$.cookie('ConcisoTestTask', JSON.stringify(HistoryItemsArray, null, 2));
	   }
        function initMap(){
			
			
			
		 map = new google.maps.Map(document.getElementById('map'), {
          zoom: 3,
		  mapTypeControl: false,
		  zoomControl: true,
			scaleControl: true,
			streetViewControl: false,
			fullscreenControl: true,

          center: {lat: 0, lng: 0}
        });
		
		
		var searchAddressField = document.getElementById("searchAddressField");
		var submitButton = document.getElementById("submitButton");
		var selectHistory = document.getElementById("selectHistory");
		
		map.controls[google.maps.ControlPosition.TOP_CENTER].push(searchAddressField);
		map.controls[google.maps.ControlPosition.TOP_CENTER].push(submitButton);
		map.controls[google.maps.ControlPosition.TOP_CENTER].push(selectHistory);

		

		
		
		//search for current position to enhance usability	
	/*	var infoWindow = new google.maps.InfoWindow({map: map});
		if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };

            infoWindow.setPosition(pos);
            infoWindow.setContent('Location found');
            map.setCenter(pos);
          }, function() {
            handleLocationError(true, infoWindow, map.getCenter());
          });
        }*/

				autocomplete = new google.maps.places.Autocomplete($("#searchAddressField")[0], {});

			   
                google.maps.event.addListener(autocomplete, 'place_changed', function() {
                    place = autocomplete.getPlace();
                   
				   if (!place.geometry) {
				   console.log("Geometry Error in the address " + $("#searchAddressField").val() );				   
					return;
					}
					center = new google.maps.LatLng( place.geometry.location.lat() , place.geometry.location.lng() );	
			    });
				
			//send data to store in cookie/DB
			//
			 HistoryItemsArray = JSON.parse($.cookie('ConcisoTestTask'));
			//console.log("storedInfo : " + HistoryItemsArray);
			
				
				for (var i = 0; i <HistoryItemsArray.length && i<defaultHistoryOptionsAmount; i++){
					let newOption = document.createElement("option");
					newOption.text = HistoryItemsArray[i].description ;
					selectHistory.add(newOption, selectHistory[1]);
					
				
				}
				
            }
			
			
			
			//use of history
			$("#selectHistory").change(function(){
				var currentHistoryVal = $("#selectHistory").val();
				$("#searchAddressField").val(currentHistoryVal);
				
				for (var i = 0; i <HistoryItemsArray.length; i++)
					if (HistoryItemsArray[i].description == currentHistoryVal)
					{
					console.log(HistoryItemsArray[i].lat);
					console.log(HistoryItemsArray[i].lng);
					center = new google.maps.LatLng(HistoryItemsArray[i].lat,HistoryItemsArray[i].lng );
					map.panTo(center);
					}
			})
</script>


<script defer async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHkxXivUMUY-WKiXtDEFfH9u0-M6VD0ZE&libraries=places&callback=initMap">
    </script>
</body>
</html>